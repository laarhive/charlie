// config/controllers/presence.json5
{
  enabled: true,

  layout: {
    // Azimuth convention:
    // - degrees clockwise from North
    // 0° = North (radar 0 forward)
    // 90° = East (right)
    // 180° = South (back)
    // 270° = West (left)
    radarAzimuthDeg: [0, 75, 285],
    radarFovDeg: 120,
    tubeDiameterMm: 100,

    ld2450: [
      { publishAs: 'LD2450A', enabled: true }, // radarId 0
      { publishAs: 'LD2450B', enabled: true }, // radarId 1
      { publishAs: 'LD2450C', enabled: true }, // radarId 2
    ],
  },

  debug: {
    // when true: main-bus targets include target.debug.*
    enabled: true,
  },

  // 3) Extrinsics / Transform Service
  extrinsics: {
    // δ0 fixed to 0 by spec; others loaded from persistence if valid
    yawOffsetsDeg: null, // null => load from store; or provide explicit override array length N
  },

  // 4) Measurement Quality Policy
  quality: {
    edgeBearingFullDeg: 30,
    edgeBearingCutoffDeg: 45,
    edgeNoiseScaleMax: 4.0,

    rangeFullMm: 1200,
    rangeCutoffMm: 3000,
    rangeNoiseScaleMax: 3.0,

    jitterWindowMs: 500,
    jitterFullMm: 60,
    jitterCutoffMm: 250,
    jitterNoiseScaleMax: 3.0,

    // 1 disables. If you see stale frames pulling fusion: set to 3 or 4 (3–4 is a reasonable safety net)
    staleNoiseScaleMax: 3
  },

  // 5–7) Tracking pipeline
  tracking: {
    mode: 'kf',

    // run tracking at 50ms; snapshot gating ensures measurements are consumed once per new snapshot
    updateIntervalMs: 50,

    maxDtMs: 400,
    dropTimeoutMs: 1500,

    snapshot: {
      // delay sampling slightly so late frames arrive and you fuse same-time-ish frames
      jitterDelayMs: 40,

      // keep defaults unless you have RAM pressure
      radarBufferMaxFrames: 5,
      radarBufferWindowMs: 4000,

      staleMeasMaxMs: 250,
      radarMissingTimeoutMs: 1500,

      // strongly recommended for multi-radar
      waitForAll: { enabled: true, timeoutMs: 110 },

      stuckTicksWarn: 20,
    },

    handover: {
      bearingSwitchMarginDeg: 8,
    },

    kf: {
      procNoiseAccelMmS2: 1200,
      measNoiseBaseMm: 140,          // slightly tighter base; your quality scalers will still expand it
      initialPosVarMm2: 250000,
      initialVelVarMm2S2: 1440000,
    },

    association: {
      gateD2Max: 9.21,
      newTrackConfirmEnabled: true,
      newTrackConfirmCount: 4,
      newTrackConfirmWindowMs: 650,
      newTrackSpawnGateMm: 400,       // slightly less aggressive than 450
    },

    fusion: {
      enabled: true,
      clusterGateMm: 360,
      maxClusterSize: 6,
      fovMarginDeg: 6,
      rangeMarginMm: 150,
    },

    health: {
      intervalMs: 1000,
      recvLagHugeMs: 500,
      slotCountMax: 3,
      tickLagWarnMult: 2,
    }
  },

  // 8) Zone Presence Engine
  zones: {
    // default: N zones from layout sectors unless overridden
    mode: 'sectors', // 'sectors' | 'polygons'
    aliases: {
      // optional stable names for UI/main-bus payloads
      zone0: 'front',
      zone1: 'right',
      zone2: 'back',
      zone3: 'left',
    },

    // fallback behavior (LD2450-only)
    enterConfirmMs: 250,
    holdMs: 2500,
    clearConfirmMs: 800,
  },

  // LD2410 policy (optional)
  ld2410: {
    enabledDefault: false,

    debounce: {
      onConfirmMs: 150,
      offConfirmMs: 600,
    },

    // per-zone override if needed later
    // zones: { zone0: { enabled: true }, ... }
  },

  // 9–10) Calibration
  calibration: {
    enabled: true,

    pairMode: 'auto', // 'auto' | 'explicit'
    minOverlapDeg: 15,

    // used when pairMode === 'explicit'
    pairList: [
      // { i: 0, j: 1 }, ...
    ],

    pairTimeMaxDeltaMs: 80,
    sessionEndGapMs: 600,

    sessionMin: {
      minPairSamplesTotal: 80,
      minPairSamplesPerActivePair: 20,
      minDisplacementMm: 1200,
      minEigenRatio: 0.08,
    },

    solver: {
      regLambda: 1e-3,
      maxConditionNumber: 1e6,
      maxUpdatePerSessionDeg: 1.0,
      maxAbsDeltaDeg: 8.0,
      violationPolicy: 'reject',
    },

    accept: {
      maxRmsTotalMm: 250,
      maxRmsPairMm: 300,
      minImprovementRatioEnabled: true,
      minImprovementRatio: 1.10,
      outlierMaxDeg: 2.5,
      outlierConfirmEnabled: true,
      outlierConfirmCount: 2,
      outlierConfirmWindowSessions: 3,
      outlierConfirmBandDeg: 1.0,
    },

    smoothing: {
      emaAlphaBase: 0.15,
      emaAlphaMin: 0.03,
      emaAlphaMax: 0.25,

      sessionQualityMin: 0.35,
      qWeights: {
        disp: 1.0,
        cov: 1.0,
        covg: 1.0,
        rms: 1.0,
      },
    },
  },

  // 11) Persistence
  persistence: {
    storeFormat: 'json',
    storeVersion: 1,
    atomicWrite: true,
    maxHistory: 50,
    // path, key, or backend id goes here later
  },
}
